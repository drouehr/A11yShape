<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>
        A11yShape Redux
    </title>
    <script src="https://cdn.tailwindcss.com">
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon/favicon-48x48.png" />
    <link rel="icon" type="image/png" sizes="64x64" href="/favicon/favicon-64x64.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>

    <style>
        :root {
            color-scheme: dark light;
        }

        .theme-dark {
            --bg: #202124;
            --panel: #18191b;
            --panel-muted: #222329;
            --border: #5d5f69;
            --text: #e5e7eb;
            --text-muted: #b9bbc2;
            --accent: #4d5057;
            --button-bg: #222329;
            --button-hover: #2f3138;
            --input-bg: #1f2026;
        }

        .theme-light {
            --bg: #f8fafc;
            --panel: #ffffff;
            --panel-muted: #f1f5f9;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-muted: #475569;
            --accent: #a0d0ff;
            --button-bg: #ffffff;
            --button-hover: #e2e8f0;
            --input-bg: #ffffff;
        }

        .app-body {
            background: var(--bg);
            color: var(--text);
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            min-height: 100vh;
            overflow: hidden;
        }

        .app-main {
            flex: 1 1 auto;
            min-height: 0;
            padding: 0.5rem;
            gap: 0.75rem;
            overflow: auto;
        }

        @media (max-height: 500px) {
            .app-body {
                height: auto;
                overflow: auto;
            }

            .app-main {
                min-height: auto;
            }
        }

        @media (max-height: 700px) {
            .app-body {
                height: auto;
                overflow: auto;
            }

            .app-main {
                min-height: auto;
                align-items: stretch;
                flex-direction: column;
                overflow: visible;
            }

            .editor-panel,
            .model-panel,
            .app-main > .panel {
                width: 100%;
                height: auto;
                min-height: 0;
                overflow: visible;
            }

            .editor-panel > *,
            .model-panel > * {
                flex: 0 0 auto;
                min-height: 0;
            }

            .editor-textarea {
                max-height: 45vh;
            }

            .response-box,
            .history-responses,
            .status-message,
            .code-changes {
                max-height: 30vh;
                overflow-y: auto;
            }

            #col2 {
                height: auto;
                min-height: 0;
            }

            .parts-panel,
            .rendered-panel {
                max-height: none;
                height: auto;
            }

            .rendered-region,
            .rendered-carousel,
            .rendered-tile-grid {
                min-height: 0;
            }
        }

        header.app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 25px;
            font-weight: bold;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--panel);
            flex: 0 0 auto;
        }

        .panel {
            background: var(--panel);
            border-radius: 0.9rem;
            border: 1px solid var(--border);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
            padding: 0.5rem;
        }

        .theme-toggle {
            padding: 0.4rem 0.6rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--button-bg);
            color: var(--text);
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            width: 2.25rem;
            height: 2.25rem;
        }

        .theme-toggle:hover {
            background: var(--button-hover);
        }

        .btn-primary,
        button:not(.theme-toggle) {
            background: var(--accent);
            color: var(--text);
            border: 1px solid transparent;
            font-weight: 600;
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.2);
            padding: 0.35rem 0.75rem;
            border-radius: 0.6rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-primary:hover,
        button:not(.theme-toggle):hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 22px rgba(15, 23, 42, 0.3);
        }

        .btn-primary:disabled,
        button:not(.theme-toggle):disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button,
        input,
        textarea,
        select {
            box-sizing: border-box;
            border-radius: 0.6rem;
            border-color: var(--border);
            background: var(--input-bg);
            color: var(--text);
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        input,
        textarea,
        select {
            margin: 0.35rem 0.5rem;
            max-width: calc(100% - 1rem);
        }

        .field-spacing {
            margin: 0.5rem;
            width: calc(100% - 1rem);
        }

        .hidden-input {
            display: none;
        }

        .editor-textarea {
            resize: none;
            min-height: 320px;
            height: auto;
            max-height: 90vh;
            width: 100%;
            overflow-y: auto;
        }

        .status-message {
            min-height: 3rem;
            height: auto;
        }

        .code-changes {
            min-height: 6rem;
            height: auto;
        }

        .prompt-textarea {
            resize: none;
            height: 6vh;
        }

        .response-container {
            height: 75%;
        }

        .response-box {
            height: 40vh;
            overflow-y: auto;
        }

        .history-responses {
            height: 22vh;
            overflow-y: auto;
        }

        .parts-panel {
            min-height: 160px;
            height: auto;
            flex: 0 1 auto;
        }

        .parts-content {
            height: 92%;
            width: 100%;
        }

        .rendered-panel {
            min-height: 240px;
            height: auto;
            flex: 1 1 auto;
        }

        .rendered-region {
            position: relative;
        }

        button:focus,
        input:focus,
        textarea:focus,
        select:focus {
            outline: 2px solid transparent;
            box-shadow: 0 0 0 2px var(--accent);
        }

        .code2fab-container {
            overflow-x: hidden;
        }

        .code2fab-content {
            white-space: pre-wrap;
            overflow-wrap: break-word;
            word-break: break-all;
            padding: 1rem;
            background: var(--panel-muted);
            color: var(--text);
            border-radius: 0.5rem;
            border: none;
        }

        .hidden {
            display: none;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .text-left {
            text-align: left;
        }

        pre {
            white-space: pre-wrap;
        }

        h2{
            font-size: 20px;
        }

        h2, h3 {
            padding: 0.5rem;
            color: var(--text);
        }

        .section-divider {
            border-top: 1px solid var(--border);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
        }

        .section-divider:first-child {
            border-top: none;
            margin-top: 0;
            padding-top: 0;
        }

        .subsection-body {
            margin: 0.25rem 0;
            padding: 0.5rem 0;
            border: none;
            background: transparent;
        }

        .bg-white {
            background-color: var(--panel) !important;
        }

        .bg-gray-100 {
            background-color: var(--panel-muted) !important;
        }

        .text-gray-600,
        .text-gray-700,
        .text-gray-500 {
            color: var(--text-muted) !important;
        }

        .border-black,
        .border-gray-300 {
            border-color: var(--border) !important;
        }

        .action-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.7rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--panel-muted);
            color: var(--text);
            font-size: 0.85rem;
        }

        .spinner {
            width: 0.9rem;
            height: 0.9rem;
            border-radius: 999px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .rendered-toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: left;
            gap: 0.5rem;
        }

        .rendered-toolbar button {
            font-size: 0.85rem;
            padding: 0.35rem 0.6rem;
        }

        .rendered-toolbar select {
            font-size: 0.85rem;
            padding: 0.35rem 0.6rem;
            border: 1px solid var(--border);
            background: var(--button-bg);
            color: var(--text);
        }

        .rendered-counter {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .toolbar-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            margin: 0 0.5rem;
        }

        .rendered-carousel {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
            height: auto;
            min-height: 100%;
            padding: 0rem;
        }

        .rendered-carousel img {
            max-height: none;
            max-width: 100%;
            height: auto;
            border-radius: 0.6rem;
            border: 1px solid var(--border);
            background: var(--panel-muted);
        }

        .rendered-thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            justify-content: center;
            align-items: center;
        }

        .rendered-thumb {
            width: 56px;
            height: 56px;
            border-radius: 0.4rem;
            border: 2px solid transparent;
            object-fit: cover;
            cursor: pointer;
            flex: 0 0 auto;
            aspect-ratio: 1 / 1;
        }

        .rendered-thumb.is-active {
            border-color: var(--accent);
        }

        .rendered-tile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            padding: 0.75rem;
        }

        .rendered-tile-grid img {
            width: 100%;
            height: auto;
            border-radius: 0.6rem;
            border: 1px solid var(--border);
            background: var(--panel-muted);
        }

        .editor-panel,
        .model-panel {
            min-height: 400px;
            height: 100%;
        }

        .editor-panel {
            min-height: 520px;
        }

        .editor-stack {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 0;
        }

        .editor-block {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-height: 0;
        }

        .editor-block.scrollable {
            flex: 1 1 auto;
            min-height: 0;
        }

        .editor-panel .section-divider.flex {
            margin-top: 0;
            padding-top: 0;
        }

        .editor-panel,
        .editor-panel > .section-divider,
        .editor-panel > .section-divider + .section-divider,
        .editor-panel > .section-divider + .section-divider + .section-divider {
            min-height: 0;
        }

        .editor-panel,
        .editor-panel > .section-divider,
        .editor-panel > .section-divider + .section-divider + .section-divider {
            display: flex;
            flex-direction: column;
        }

        .editor-panel > .section-divider {
            flex: 1 1 auto;
        }

        .editor-panel > .section-divider + .section-divider {
            flex: 0 0 auto;
        }

        .editor-panel > .section-divider + .section-divider + .section-divider {
            flex: 0 0 auto;
        }

        .editor-panel > .section-divider + .section-divider + .section-divider + .section-divider {
            flex: 1 1 auto;
        }

        .editor-panel textarea.editor-textarea {
            min-height: 320px;
            max-height: 90vh;
        }

        .editor-panel .status-message,
        .editor-panel .code-changes {
            max-height: 30vh;
        }

        #col2 {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }

        .parts-panel {
            height: auto !important;
            flex: 0 0 auto;
            max-height: 35vh;
        }

        .rendered-panel {
            flex: 1 1 auto;
            min-height: 0;
        }

        .rendered-region {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 0;
        }

        .rendered-carousel,
        .rendered-tile-grid {
            flex: 1 1 auto;
        }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>


<body class="bg-white app-body">

    <header class="app-header">
        <div class="flex items-center gap-3">
            <img src="/favicon/favicon-180x180.png" alt="A11yShape logo" class="w-10 h-10" />
            <h1>A11yShape Redux</h1>
        </div>
        <button id="theme-toggle" class="theme-toggle" type="button" aria-label="Toggle color theme">
            <i id="theme-icon" class="fas fa-sun" aria-hidden="true"></i>
        </button>
    </header>
    <!-- Main Content -->
    <div class="app-main flex w-full">
        <!-- Code Editor area -->
        <div class="w-1/3 bg-white border border-gray-300 flex-col flex flex-col panel editor-panel" tabindex="0"
            aria-labelledby="editor-heading" role="region">
            <h2 role="heading" id="editor-heading">Code Editor Panel</h2>
            <div class="editor-stack">
                <div class="section-divider editor-block" tabindex="0" aria-labelledby="code-editor-heading" role="region">
                    <h3 role="heading" id="editor-controls-heading">Editor Controls</h3>
                    <div tabindex="0" aria-label="editor-toolbar" role="toolbar" aria-labelledby="editor-controls-heading">
                        <div class="section-divider flex justify-between items-center flex-none">
                            <div class="toolbar-row">
                                <button class="btn-primary" id="upload-file"
                                    tabindex="0" aria-label="Upload OpenSCAD file" aria-controls="file-input">
                                    <i class="fas fa-upload" aria-hidden="true"></i>
                                    <span>Import file</span>
                                    <span class="sr-only">Upload OpenSCAD file</span>
                                </button>
        
                                <button class="btn-primary" id="save-code"
                                    tabindex="0" aria-label="Save the OpenSCAD code">
                                    <i class="fas fa-save" aria-hidden="true"></i>
                                    <span>Save</span>
                                    <span class="sr-only">Save OpenSCAD code</span>
                                </button>
        
                                <input type="file" id="file-input" class="hidden-input" accept=".scad"
                                    aria-label="Open an OpenSCAD file.">
                                    
                                <button class="btn-primary" id="undo-code"
                                    tabindex="0" aria-label="Undo code changes" disabled>
                                    Undo
                                </button>
                                <button class="btn-primary" id="redo-code"
                                    tabindex="0" aria-label="Redo code changes" disabled>
                                    Redo
                                </button>
                                <button tabindex="0" aria-label="Generate Model"
                                    class="btn-primary interactive"
                                    id="generate-model">
                                    <!--<i class="fas fa-cube"></i>-->
                                    Generate Model
                                </button>
                                
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-divider editor-block scrollable" tabindex="0" aria-labelledby="editor-input-heading" role="region">
                    <h2 role="heading" id="editor-input-heading"> Code Editor</h2>
                    <textarea tabindex="0" aria-labelledby="editor-input-heading" role="textbox"
                        class="p-2 text-sm text-gray-700 font-mono focus:outline-none interactive editor-textarea field-spacing" id="openscad-code"
                        placeholder="Enter OpenSCAD code here"
                        data-hover-text="Enter OpenSCAD code here."></textarea>
                </div>
                    
                <div class="section-divider editor-block" tabindex="0" aria-labelledby="status-heading" role="status">
                  <h2 role="heading" id="status-heading"> Errors</h2>
                  <div class="w-full overflow-auto field-spacing status-message"
                      id="status-message">
                      
                  </div>
                </div>
                
                <div class="section-divider editor-block" tabindex="0" aria-labelledby="changes-heading" role="region">
                    <h2 role="heading" id="changes-heading"> Code Changes</h2>
                    <ul tabindex="0" class="w-full overflow-auto field-spacing code-changes"
                        id="code-changes" aria-labelledby="changes-heading" role="list">
                    </ul>
                </div>
            </div>
        </div>
        <!-- AI Area -->
        <div class="w-1/3 border border-gray-300 flex-col overflow-auto panel" tabindex="0"
            aria-labelledby="ai-panel-heading" role="region">
            <h2 role="heading" id="ai-panel-heading">AI Assistance Panel</h2>
            <div class="section-divider" tabindex="0" aria-labelledby="prompt-heading" role="region">
                <!-- Prompt Area at the top-->
                <h3 role="heading" id="prompt-heading"> Command:</h3>
                <div class="h-1/4 mb-1 overflow-auto flex flex-col subsection-body">

                    <div class="flex items-center gap-2 p-2">
                        <label for="mode-select" class="text-sm text-gray-700">Mode</label>
                        <select id="mode-select" class="text-sm text-gray-700 px-2 py-1"
                            aria-label="Select mode">
                            <option value="auto">Auto</option>
                            <option value="describe">Describe</option>
                            <option value="modify">Modify</option>
                        </select>
                    </div>

                    <div class="h-1/4">
                        <div id="action-indicator" class="action-indicator hidden mb-2" role="status" aria-live="polite" aria-busy="false">
                            <span class="spinner" aria-hidden="true"></span>
                            <span id="action-text">Working</span>
                        </div>
                        <textarea
                            class="w-full p-2 text-sm text-gray-700 font-mono focus:outline-none interactive bg-gray-100 prompt-textarea field-spacing"
                            id="gpt-input" placeholder="Enter your prompt here"
                            aria-label="Prompt box" role="textbox"></textarea>
                        <!-- Buttons below the prompt textbox -->
                        <div class="toolbar-row" role="toolbar" aria-label="Prompt actions">
                            <button aria-label="Submit prompt"
                                class="btn-primary"
                                id="callGPT">
                                Enter
                            </button>
                        </div>

                    </div>
                </div>
            </div>
            <!-- Response Area at the bottom -->
            <div class="section-divider" tabindex="0" aria-labelledby="response-heading" role="status" aria-live="polite">
                <h3 role="heading" id="response-heading"> A11yShape Response:</h3>
                <div class="code2fab-container w-full text-sm text-gray-700 font-mono flex-col response-container">
                    <!-- GPT response content goes here -->
                    <div id="code2fab-response"
                        class="code2fab-content h-full overflow-auto text-gray-500 interactive flex-shrink-0 field-spacing response-box"
                        data-hover-text="code2fab's response"><br><br> Model description not yet generated<br>
                    </div>
                </div>
            </div>
            <div id="history-responses-area" class="section-divider overflow-y: scroll"
                role="region" aria-label="History" tabindex="0">
                <h3 role="heading" id="history-heading"> Response History:</h3>
                <div class="toolbar-row" role="toolbar" aria-label="History actions">
                    <button aria-label="Clear history"
                        class="btn-primary"
                        id="clearHistory">
                        Clear
                    </button>
                </div>
                <div id="history-responses" class="history-responses field-spacing"></div>
            </div>
        </div>
        <!-- Rendering Area -->
        <div class="w-1/3 flex-col border border-gray-300 panel model-panel" tabindex="0" aria-labelledby="model-panel-heading"
            role="region">
            <h2 role="heading" id="model-panel-heading">Model Panel</h2>
            <div class="section-divider" aria-hidden="true"></div>
            <div class="flex-col" id="col2">

                <div class="section-divider w-full h-1/2 overflow-auto parts-panel" tabindex="0" aria-labelledby="parts-heading">
                    <h3 role="heading" id="parts-heading"> Model parts</h3>
                    <div class="h-full p-2 text-sm text-gray-700 font-mono focus:outline-none interactive parts-content field-spacing"
                        id="openscad-code2" placeholder="The modular structure of the code will appear here">
                        <p>The parts of model will appear here...</p>
                    </div>
                </div>

                <!-- Viewport Content -->
                <div class="section-divider flex-grow flex rendered-panel">
                    <div class="w-full flex-grow justify-center items-center overflow-auto rendered-region"
                        tabindex="0" aria-labelledby="rendered-heading" role="region">
                        <h3 role="heading" id="rendered-heading"> Rendered model</h3>
                        <div class="rendered-toolbar toolbar-row" role="toolbar" aria-label="Rendered model view controls">
                            <button id="rendered-prev" type="button" aria-label="Previous view" class="btn-primary">Prev</button>
                            <button id="rendered-next" type="button" aria-label="Next view" class="btn-primary">Next</button>
                            <label for="rendered-view-select" class="sr-only">Select view mode</label>
                            <select id="rendered-view-select" aria-label="View mode">
                                <option value="carousel">Carousel</option>
                                <option value="tiles">Tile view</option>
                            </select>
                            <span id="rendered-counter" class="rendered-counter" aria-live="polite">View 1 of 1</span>
                        </div>

                        <div id="rendered-carousel" class="rendered-carousel" aria-live="polite">
                            <img id="modelImage" src="/static/img/logo.png" tabindex="0" aria-label="Rendered model"
                                aria-describedby="code2fab-response" role="img" class="max-w-full">
                            <div id="rendered-thumbnails" class="rendered-thumbnails" aria-label="Rendered model thumbnails"></div>
                        </div>
                        <div id="rendered-tiles" class="rendered-tile-grid hidden" aria-label="Rendered model tile view"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>
    </div>

    <script src="/config.js"></script>
    <script src="https://unpkg.com/xregexp/xregexp-all.js"></script>
    <script>
        const serverUrl = window.__A11YSHAPE_API_BASE__ || window.location.origin;
        const themeStorageKey = "a11yshape-theme";
        const themeToggle = document.getElementById("theme-toggle");
        const themeIcon = document.getElementById("theme-icon");
        const themeRoot = document.documentElement;

        function applyTheme(mode) {
            themeRoot.classList.remove("theme-dark", "theme-light");
            themeRoot.classList.add(`theme-${mode}`);
            if (themeToggle) {
                const nextLabel = mode === "dark" ? "Light mode" : "Dark mode";
                themeToggle.setAttribute("aria-label", nextLabel);
                themeToggle.setAttribute("aria-pressed", mode === "dark" ? "true" : "false");
            }
            if (themeIcon) {
                themeIcon.className = mode === "dark" ? "fas fa-sun" : "fas fa-moon";
            }
        }

        const savedTheme = localStorage.getItem(themeStorageKey);
        applyTheme(savedTheme === "light" ? "light" : "dark");

        if (themeToggle) {
            themeToggle.addEventListener("click", () => {
                const isDark = themeRoot.classList.contains("theme-dark");
                const next = isDark ? "light" : "dark";
                localStorage.setItem(themeStorageKey, next);
                applyTheme(next);
            });
        }

        // Display and update the status
        const statusDisplay = document.getElementById('statusText');
        const actionIndicator = document.getElementById('action-indicator');
        const actionText = document.getElementById('action-text');
        function updateStatusAndSpeak(text) {
            //speechSynthesis.cancel();
            //statusDisplay.textContent = text;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 5;
            //speechSynthesis.speak(utterance);
        }

        function setLoading(action) {
            if (!actionIndicator || !actionText) {
                return;
            }
            actionText.textContent = action;
            actionIndicator.classList.remove('hidden');
            actionIndicator.setAttribute('aria-busy', 'true');
        }

        function clearLoading() {
            if (!actionIndicator) {
                return;
            }
            actionIndicator.classList.add('hidden');
            actionIndicator.setAttribute('aria-busy', 'false');
        }

        const editorTextarea = document.getElementById('openscad-code');

        function resizeEditorTextarea() {
            if (!editorTextarea) {
                return;
            }
            editorTextarea.style.height = 'auto';
            const targetHeight = Math.min(editorTextarea.scrollHeight, window.innerHeight * 0.9);
            editorTextarea.style.height = `${targetHeight}px`;
        }

        if (editorTextarea) {
            resizeEditorTextarea();
            editorTextarea.addEventListener('input', resizeEditorTextarea);
            window.addEventListener('resize', resizeEditorTextarea);
        }

        const elements = [
            { id: "save-code", key: "Ctrl+Shift+S", text: "Save the OpenSCAD code." },
            //{ id: "refresh-files", key: "Ctrl+Shift+R", text: "Clear the file list." },
            { id: "upload-file", key: "Ctrl+Shift+U", text: "Upload a new OpenSCAD file." },
            //{ id: "file-list", key: "Ctrl+Shift+L", text: "Open the version list." },
            { id: "generate-model", key: "Ctrl+Shift+G", text: "Generate a 3D model from the code." },
            { id: "openscad-code", key: "Ctrl+Shift+O", text: "Enter OpenSCAD code here." },
            { id: "gpt-input", key: "Ctrl+Shift+P", text: "Enter your input here." },
        ];


        document.addEventListener('keydown', function (event) {
            //console.log(event.key, event.ctrlKey, event.shiftKey);
            if (event.ctrlKey && event.shiftKey) {
                elements.forEach(item => {
                    if (event.key.toUpperCase() === item.key.split('+').pop()) {
                        const element = document.getElementById(item.id);
                        if (element) {
                            element.focus();
                            updateStatusAndSpeak(item.text);
                        }
                    }
                });
            } else if (event.altKey && !event.shiftKey && !event.ctrlKey) {
                if (event.key.toUpperCase() === "E") {
                    const element = document.getElementById("openscad-code");
                    if (element) {
                        element.focus();
                        updateStatusAndSpeak("Focused OpenSCAD code editor.");
                    }
                } else if (event.key.toUpperCase() === "P") {
                    const element = document.getElementById("gpt-input");
                    if (element) {
                        element.focus();
                        updateStatusAndSpeak("Focused prompt input.");
                    }
                }
            }
        });

        elements.forEach(item => {
            const element = document.getElementById(item.id);
            if (element) {
                element.addEventListener('focus', function () {
                    updateStatusAndSpeak(item.text);
                });
                element.addEventListener('mouseenter', function () {
                    updateStatusAndSpeak(item.text);
                });
            }
        });
        
        var session_id = new Date().getTime();

        const imageBasePath = '/static/img/model/';
        const totalImages = 7; // Assuming images are named from 0.jpg to 6.jpg
        let currentImageIndex = 0;
        let renderedImages = [];
        let renderedThumbnails = [];
        let renderedFullImages = [];
        let renderedFullThumbnails = [];
        let renderedViewMode = 'carousel';

        const renderedPrevButton = document.getElementById('rendered-prev');
        const renderedNextButton = document.getElementById('rendered-next');
        const renderedViewSelect = document.getElementById('rendered-view-select');
        const renderedCounter = document.getElementById('rendered-counter');
        const renderedTiles = document.getElementById('rendered-tiles');
        const renderedCarousel = document.getElementById('rendered-carousel');
        const renderedThumbnailsContainer = document.getElementById('rendered-thumbnails');
        const imageElement = document.getElementById('modelImage');

        var prevCode = '';
        var parts = [];
        let currentPart = { index: 0, code: "", offset: 0 };
        parts.push({
            id: 0,
            name: "Model",
            description: "",
            children: [],
            code: "",
            isModule: false
        });

        let historyResponses = [];
        var codeHistory = [""];
        var historyIndex = 0;
        var prevPrompt = "";
        
        const dingSound = new Audio("static/ding.wav");
        const errorSound = new Audio("static/error.wav");
        const clockSound = new Audio("static/tick.wav");
        clockSound.loop = true;

        /**function storeAndDisplayHistoryResponse(newResponse) {
            historyResponses.unshift(newResponse); 
            const historyContainer = document.getElementById('history-responses'); 
            const responseElement = document.createElement('pre');
            responseElement.textContent = newResponse;
            responseElement.classList.add('mb-2', 'p-2', 'border', 'rounded-md', 'bg-gray-100', 'text-gray-500');
            responseElement.setAttribute('role', 'history response');  
            responseElement.setAttribute('tabindex', '0'); 
            historyContainer.prepend(responseElement);
        }**/

        async function storeAndDisplayHistoryResponse(newResponse, code) {
            const id = historyResponses.length;
            historyResponses.push({"id": id, "response": newResponse, "code": code});
            
            const historyContainer = document.getElementById('history-responses');
            historyContainer.innerHTML = "";
            
            let start = 0;
            if (historyResponses.length > 10) {
              start = historyResponses.length - 10;
            }
            for (let i = start; i < historyResponses.length; i++) {
              const responseButton = document.createElement('button');
              const responseElement = document.createElement('pre');
              responseElement.classList.add('mb-2', 'p-2', 'border', 'rounded-md', 'bg-gray-100', 'text-gray-500');
              responseElement.setAttribute('role', 'history response');
              responseElement.setAttribute('tabindex', '0');
              responseElement.setAttribute('data-id', id);
              responseElement.setAttribute('onclick', "historySelected(event)");
              responseElement.style["text-align"] = "left";
              responseButton.prepend(responseElement);
              historyContainer.prepend(responseButton);

              const formData = new FormData();
              formData.append('text', historyResponses[i].response);
              responseElement.textContent = historyResponses[i].response;
            }
            
            
            //console.log(historyResponses);
        }
        
        function historySelected(e) {
            
            var selected = e.target;
            const id = parseInt(selected.getAttribute("data-id"));
            if (id < 0 || id >= historyResponses.length) {
              return;
            }
            const hist = historyResponses[id];
            //console.log(hist);
            //prevCode = document.getElementById('openscad-code').value;
            document.getElementById('openscad-code').value = hist.code;
            document.getElementById('generate-model').click();
        }
        
        function codeChangeSelected(e) {
            
            var selected = e.target;
            if (selected.getAttribute("data-start") == -1) {
              return;
            }
            document.getElementById('openscad-code').focus();
            document.getElementById('openscad-code').setSelectionRange(parseInt(selected.getAttribute("data-start")), parseInt(selected.getAttribute("data-end")));
        }
        
        function displayChanges(code, changes) {
          var lineIndex = [0];
          for(var i=0; i<code.length-1; i++) {
              if (code[i] === "\n") lineIndex.push(i+1);
          }
          lineIndex.push(code.length);
          
          var output = "";
          
          for(var i=0; i<changes.length; i++) {
              var lines = "Lines "+changes[i].startLine+" - " + changes[i].endLine + ": ";
              if (changes[i].startLine == -1) {
                lines = "";
              } else if (changes[i].startLine == changes[i].endLine) {
                lines = "Line "+changes[i].startLine + ": ";
              }
              
              output += "<li aria-labelledby=\"change-" + i + "\"  >"
                + "<button id=\"change-" + i + "\" onclick=\"codeChangeSelected(event)\" tabindex=\"0\" data-start=\"" + lineIndex[changes[i].startLine] + "\" data-end=\"" + lineIndex[changes[i].endLine+1] + "\" aria-label=\""+changes[i].description+"\" role=\"listitem\" style=\"text-align: left;\" >"+lines + changes[i].description + " </button></li>";
          }
          
          
          document.getElementById('code-changes').innerHTML = output;
        }

        function updateRenderedCounter() {
            const total = renderedImages.length || 1;
            const current = renderedImages.length ? currentImageIndex + 1 : 1;
            if (renderedCounter) {
                renderedCounter.textContent = `View ${current} of ${total}`;
            }
        }

        function buildRenderedThumbnails() {
            if (!renderedThumbnailsContainer) {
                return;
            }
            renderedThumbnailsContainer.innerHTML = "";
            renderedThumbnails.forEach((thumb, index) => {
                const thumbImg = document.createElement('img');
                thumbImg.src = thumb;
                thumbImg.alt = `Thumbnail view ${index + 1}`;
                thumbImg.className = "rendered-thumb" + (index === currentImageIndex ? " is-active" : "");
                thumbImg.addEventListener('click', () => {
                    setRenderedIndex(index);
                });
                renderedThumbnailsContainer.appendChild(thumbImg);
            });
        }

        function buildRenderedTiles() {
            if (!renderedTiles) {
                return;
            }
            renderedTiles.innerHTML = "";
            renderedImages.forEach((img, index) => {
                const tileImg = document.createElement('img');
                tileImg.src = img;
                tileImg.alt = `Rendered model view ${index + 1}`;
                renderedTiles.appendChild(tileImg);
            });
        }

        function setRenderedIndex(index) {
            if (!renderedImages.length) {
                currentImageIndex = 0;
                updateRenderedCounter();
                return;
            }
            const total = renderedImages.length;
            currentImageIndex = (index + total) % total;
            if (imageElement) {
                imageElement.src = renderedImages[currentImageIndex];
            }
            updateRenderedCounter();
            buildRenderedThumbnails();
        }

        function setRenderedMode(mode) {
            renderedViewMode = mode;
            if (renderedViewSelect) {
                renderedViewSelect.value = mode;
            }
            if (renderedCarousel && renderedTiles) {
                if (mode === 'tiles') {
                    renderedCarousel.classList.add('hidden');
                    renderedTiles.classList.remove('hidden');
                } else {
                    renderedCarousel.classList.remove('hidden');
                    renderedTiles.classList.add('hidden');
                }
            }
        }

        if (renderedPrevButton) {
            renderedPrevButton.addEventListener('click', () => {
                setRenderedIndex(currentImageIndex - 1);
            });
        }

        if (renderedNextButton) {
            renderedNextButton.addEventListener('click', () => {
                setRenderedIndex(currentImageIndex + 1);
            });
        }

        if (renderedViewSelect) {
            renderedViewSelect.addEventListener('change', (event) => {
                setRenderedMode(event.target.value);
            });
        }

        async function genImageAndDescribe(index, text) {
            clockSound.play();
            var callId = new Date().getTime();
            var code = document.getElementById('openscad-code').value;
            const selectedMode = document.getElementById('mode-select')?.value || "describe";
            const actionLabel = text ? "Processing prompt" : "Generating model";
            setLoading(actionLabel);
            console.log(codeHistory);
            if (prevCode != code && code != codeHistory[historyIndex]) {
              codeHistory.length = historyIndex+1;
              codeHistory.push(code);
              historyIndex++;
            }
                        
            console.log(code);
            var fullCode = "";
            if (currentPart.index != 0) {
                fullCode = code;
                code = code.slice(0, currentPart.offset) + "#" + code.slice(currentPart.offset);
                console.log(code);
            }
            
            const statusContainer = document.getElementById('status-message');
            statusContainer.innerHTML = "";
            
            //console.log("Generating images for code:", code);

            try {
                // Generate images from code
                const generateResponse = await fetch(serverUrl + '/generate-img', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: session_id, callId: callId, code: code, prevCode: prevCode, fullCode: fullCode, imageIndex: index, text: text, mode: selectedMode })
                });

                if (!generateResponse.ok) {
                    throw new Error(`HTTP error! Status: ${generateResponse.status}`);
                }

                const generateData = await generateResponse.json();

                console.log(generateData);

                if (generateData.message && generateData.message === "Images generated successfully") {
                    updateStatusAndSpeak("Images have been successfully generated.");

                    const mode = generateData.mode;
                    if (mode == "modify" && text != "") {
                      currentPart = { index: 0, code: "", offset: 0 };
                    }
     
                    if (generateData.changes != '') {
                      displayChanges(code, JSON.parse(generateData.changes));
                    }

                    renderedImages = (generateData.images || []).map((img) => `data:image/jpeg;base64,${img}`);
                    renderedThumbnails = (generateData.thumbnails || []).map((img) => `data:image/jpeg;base64,${img}`);
                    renderedFullImages = (generateData.fullImages || []).map((img) => `data:image/jpeg;base64,${img}`);
                    renderedFullThumbnails = (generateData.fullThumbnails || []).map((img) => `data:image/jpeg;base64,${img}`);

                    if (renderedImages.length) {
                        setRenderedIndex(0);
                    } else if (generateData.image) {
                        const byteCharacters = atob(generateData.image);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        if (imageElement) {
                            imageElement.src = URL.createObjectURL(new Blob([byteArray], { type: 'image/png' }));
                        }
                    }

                    buildRenderedTiles();
                    buildRenderedThumbnails();
                    updateRenderedCounter();

                    //const instructions = document.getElementById('placeholder');
                    //instructions.style["display"] = "none";

                    //updateImageDisplay(0); // Reset to the first image

                    // Now process the model image and send it along with the text and code
                    updateStatusAndSpeak("The system reply is loading...");

                    // Wait for the model image to be updated in the DOM
                    setTimeout(() => {
                        var code = document.getElementById('openscad-code').value;
                        var fullCode = "";
                        var partCode = "";
                        if (currentPart.index != 0) {
                            fullCode = code.slice(0, currentPart.offset) + "#" + code.slice(currentPart.offset);;
                            /*for (let i = 0; i < parts.length; i++) {
                                if (parts[i].id == currentPart.index) {
                                    partCode = currentPart.code + ";\n" + parts[i].code;
                                    break;
                                }
                            }*/
                            code = code.slice(0, currentPart.offset) + "!" + code.slice(currentPart.offset);
                            partCode = code.slice(0, currentPart.offset) + "/* part of the model --> */" + code.slice(currentPart.offset);
                        }
                        
                        updateStatusAndSpeak("The system reply is loading...")

                        var newCode = "";
                        var newResponse = "";

                        var body = { sessionId: session_id, callId: callId, text: text, code: code, mode: mode, prevCode: prevCode, fullCode: fullCode, partCode: partCode };
                        if (text != "") {
                            body["prevCode"] = "";
                        }

                        fetch(serverUrl + '/api/describe', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        })
                            .then(response => {

                                console.log(response);
                                const reader = response.body.getReader();
                                function processStream({ done, value }) {
                                    if (done) {
                                        
                                    
                                        console.log('Stream completed');
                                        updateStatusAndSpeak("Please check the system reply.");
                                        
                                        
                                        if (mode == "modify" && text != "") {
                                            prevCode = document.getElementById('openscad-code').value;
                                            newCode = newCode.replace("```openscad", "").replace("```", "").trim();
                                            document.getElementById('openscad-code').value = newCode;
                                            parseCode(newCode);
                                            document.getElementById('undo-code').disabled = false;
                                            document.getElementById('redo-code').disabled = true;
                                            prevPrompt = text;
                                            clearLoading();
                                            document.getElementById('generate-model').click();
                                            return;
                                        }
                                        
                                        if (generateData.changes != '') {
                                          newResponse += "\nCode changes:"
                                          const changes = JSON.parse(generateData.changes);
                                          for(var i=0; i<changes.length; i++) {
                                            var lines = "Lines "+changes[i].startLine+" - " + changes[i].endLine + ": ";
                                            if (changes[i].startLine == -1) {
                                              lines = "";
                                            } else if (changes[i].startLine == changes[i].endLine) {
                                              lines = "Line "+changes[i].startLine + ": ";
                                            }
                                            
                                            newResponse += "\n"+lines+changes[i].description
                                          }
                                        }
                                        
                                        const responseContainer = document.getElementById('code2fab-response');
                                        responseContainer.innerHTML = '';
                                        const responsePre = document.createElement('pre');
                                        responseContainer.appendChild(responsePre);
                                        responseContainer.ariaLabel = "";
                                        responsePre.textContent = newResponse;
                                        responseContainer.ariaLabel = newResponse;
                                        var history = newResponse;
                                        if (text != "") {
                                          history = "Prompt: "+text+"\n\n"+history;
                                        } else if (prevPrompt != "") {
                                          history = "Prompt: "+prevPrompt+"\n\n"+history;
                                          prevPrompt = "";
                                        }
                                        storeAndDisplayHistoryResponse(history, code);
                                        
                                        clockSound.pause();
                                        clockSound.currentTime = 0;
                                        dingSound.play();
                                        clearLoading();
                                        
                                        responseContainer.focus();
                                        return;
                                    }
                                    const chunk = new TextDecoder().decode(value);

                                    if (mode == "modify") {
                                        newCode += chunk;
                                    } else {
                                        newResponse += chunk;
                                    }

                                    return reader.read().then(processStream);
                                }
                                reader.read().then(processStream);
                                updateStatusAndSpeak("The response stream finished without a usable reply. Please try again or check the server logs for details.");


                            })
                            .catch(error => {
                                console.error('Error:', error);
                                updateStatusAndSpeak("The request to the description service failed. Please verify the backend is running and try again.");
                                clockSound.pause();
                                errorSound.play();
                                clearLoading();
                                statusContainer.innerHTML = "Failed to generate a system reply. The description API request failed or was interrupted. Please confirm the backend service is running and your network connection is stable, then retry.";
                            });

                        prevCode = code;
                        if (fullCode != "") {
                          prevCode = fullCode;
                        }
                        

                    }, 1);

                } else {
                    console.error("Failed to generate or retrieve images.");
                    updateStatusAndSpeak("Failed to generate images.");
                    clockSound.pause();
                    errorSound.play();
                    clearLoading();
                    if (generateData.message == "OpenSCAD code error") {
                      statusContainer.innerHTML = '<pre>'+generateData.error+'<\pre>';
                    } else {
                      statusContainer.innerHTML = "Failed to generate a system reply. Please check if the backend is running and try again!";
                    }
                }
            } catch (error) {
                console.error('Error during generation or loading:', error);
                updateStatusAndSpeak("An error occurred during image generation. This could be caused by invalid OpenSCAD code or a backend processing failure.");
                clockSound.pause();
                errorSound.play();
                clearLoading();
                statusContainer.innerHTML = "Failed to generate a system reply. Image generation or parsing failed before a response could be returned. Please check the OpenSCAD code for errors and verify the backend service is online.";
            }

        }

        document.getElementById('generate-model').addEventListener('click', async function () {
            console.log("gen");

            await genImageAndDescribe(currentImageIndex, "");

        });
        
        document.getElementById('clearHistory').addEventListener('click', async function () {
            historyResponses = [];
            document.getElementById('history-responses').innerHTML = '';
        });
        
        document.getElementById('undo-code').addEventListener('click', async function () {
          console.log(codeHistory);
          console.log(historyIndex);
        
          var code = document.getElementById('openscad-code').value;
          if (code != codeHistory[historyIndex]) {
            codeHistory.push(code);
          } else {
            historyIndex--;
          }
          
          if (historyIndex == 0) {
            document.getElementById('undo-code').disabled = true;
          }
          document.getElementById('redo-code').disabled = false;
          
          document.getElementById('openscad-code').value = codeHistory[historyIndex];
          prevCode = code;
          parseCode(codeHistory[historyIndex]);
          await genImageAndDescribe(currentImageIndex, "");
        });
        
        document.getElementById('redo-code').addEventListener('click', async function () {
          var code = document.getElementById('openscad-code').value;
          historyIndex++;
          var newCode = codeHistory[historyIndex];
          
          if (historyIndex == codeHistory.length-1) {
            document.getElementById('redo-code').disabled = true;
          }
          document.getElementById('undo-code').disabled = false;
          
          document.getElementById('openscad-code').value = newCode;
          prevCode = code;
          parseCode(newCode);
          await genImageAndDescribe(currentImageIndex, "");
        });

        document.getElementById('callGPT').addEventListener('click', async function () {
            const textInput = document.getElementById('gpt-input').value.trim();
            document.getElementById("gpt-input").value = "";
            await genImageAndDescribe(currentImageIndex, textInput);
        });

        document.getElementById("gpt-input").addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById("callGPT").click();
            }
        });

        function modelPartSelected(e) {
            prevCode = "";
            
            var selected = e.target;
            
            const prevPart = document.getElementById('part-' + currentPart.index);
            prevPart.style.color = "black";
            
            console.log(currentPart);

            selected.style.color = "blue";
            
            if (currentPart.index != selected.getAttribute("data-id")) {
              currentPart.index = selected.getAttribute("data-id");
              currentPart.code = selected.getAttribute("data-code");
              currentPart.offset = selected.getAttribute("data-offset");
              
              document.getElementById('openscad-code').focus();
              document.getElementById('openscad-code').setSelectionRange(currentPart.offset, parseInt(currentPart.offset)+currentPart.code.length);
              document.getElementById('generate-model').click();
            }
            console.log(currentPart);
        }


        document.addEventListener('keydown', async function (event) {
            if (event.shiftKey && event.key.toUpperCase() === 'V') {
                if (renderedImages.length) {
                    setRenderedIndex(currentImageIndex + 1);
                } else {
                    currentImageIndex = (currentImageIndex + 1) % totalImages; // Increment index and loop back to 0
                    await genImageAndDescribe(currentImageIndex, "");
                }
                updateStatusAndSpeak(`Viewing image number ${currentImageIndex}.`);
            }

            if (event.altKey && (event.key === '!' || event.key === '@' || event.key === '#')) {
                var col = '1';
                if (event.key === '@') {
                    col = '2';
                } else if (event.key === '#') {
                    col = '3';
                }
                var column = document.getElementById('col' + col);
                column.focus();
            }

            if (event.shiftKey && event.altKey) {
                if (event.key.toUpperCase() == 'G') {
                    await genImageAndDescribe(currentImageIndex, "");
                } else if (event.key.toUpperCase() == 'D') {
                    var section = document.getElementById('code2fab-response');
                    section.focus();
                } else if (event.key.toUpperCase() == 'E') {
                    var section = document.getElementById('openscad-code');
                    section.focus();
                } else if (event.key.toUpperCase() == 'S') {
                    saveCode();
                } else if (event.key.toUpperCase() == 'O') {
                    document.getElementById('file-input').click();
                    var section = document.getElementById('openscad-code');
                    section.focus();
                    prevCode = "";
                } else if (event.key.toUpperCase() == 'H') {
                    const instructions = document.getElementById('placeholder');
                    instructions.style["display"] = "block";
                    instructions.focus();
                } else if (event.key.toUpperCase() == 'C') {
                    var section = document.getElementById('toolbar');
                    section.focus();
                }
            }
        });


        function updateImageDisplay(index) {
            const imageElement = document.getElementById('modelImage');
            const placeholder = document.getElementById('placeholder');

            // Check if the index is within the valid range
            if (index >= 0 && index <= 6) {
                const imagePath = `${imageBasePath}${index}.png`;
                imageElement.src = imagePath;
                imageElement.onerror = function () {
                    // If the image fails to load, hide the image and show the placeholder
                    imageElement.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                };
                imageElement.onload = function () {
                    // If the image loads successfully, show the image and hide the placeholder
                    imageElement.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                };
            } else {
                // If the index is out of the valid range, hide the image and show the placeholder
                imageElement.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        function saveCode() {
            const code = document.getElementById('openscad-code').value;
            let fileName = prompt("Enter file name (leave blank for automatic naming):");

            if (fileName === null) {
                return;
            }

            if (fileName.trim() === '') {
                fileName = undefined;
            } else {
                if (!fileName.endsWith('.scad')) {
                    fileName += '.scad';
                }
            }

            const link = document.createElement("a");
            const content = code;
            const file = new Blob([content], { type: 'text/plain' });
            link.href = URL.createObjectURL(file);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // Save the code to a file
        document.getElementById('save-code').addEventListener('click', function () {
            saveCode();

        });

        // Load code from a file
        function loadCode(fileName) {
            fetch(serverUrl + `/load-code/${fileName}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('openscad-code').value = data.code;
                    console.log(`Loaded code from file: ${fileName}`);
                })
                .catch(error => {
                    console.error('Error loading code:', error);
                    console.error('Error loading file.');
                });
        }

        // Upload a file
        document.getElementById('upload-file').addEventListener('click', function () {
            document.getElementById('file-input').click();
            var section = document.getElementById('openscad-code');
            section.focus();
            prevCode = "";
            document.getElementById('undo-code').disabled = false;
            document.getElementById('redo-code').disabled = true;
            document.getElementById('code-changes').innerHTML = "";
        });
        document.getElementById('file-input').addEventListener('change', function (event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('openscad-code').value = e.target.result;
                console.log(`Uploaded file: ${file.name}`);
                parseCode(document.getElementById('openscad-code').value);
                document.getElementById('undo-code').disabled = false;
                document.getElementById('redo-code').disabled = true;
                genImageAndDescribe(currentImageIndex, "");
            };
            reader.readAsText(file);
        });



        function getDisplayTree(root, child, index, level) {


            let tree = "<li style=\"padding-left: 10px;\" aria-labelledby=\"part-" + root.id + "\"  >"
                /*+ "<input type=\"checkbox\" id=\"part-" + root.id + "\" name=\"parts\" value=\"" + root.id + "\" data-offset=\"" + child.start + "\" data-code=\"" + child.code + "\"  aria-labelledby=\"part-" + root.id + "-label\" role=\"checkbox\" tabindex=\"-1\" onchange=\"modelPartSelected(event)\">"*/
                + "<button id=\"part-" + root.id + "\" onclick=\"modelPartSelected(event)\" tabindex=\"0\" data-id=\"" + root.id + "\" data-offset=\"" + child.start + "\" data-code=\"" + child.code + "\" aria-label=\"level "+level+" "+child.name+"\" aria-level=\""+level+"\" role=\"listitem\" > Level "+level+" " + child.name + " </button>";

            if (root.id == -1 || root.children.length == 0) {
                return tree + "</li>";
            }
            const children = root.children;

            tree = tree + "<ul style=\"padding-left: 10px;\" role=\"list\">";
            for (let i = 0; i < children.length; i++) {
                tree = tree + getDisplayTree(parts[children[i].id], children[i], index + (i + 1) + ".", level+1);
            }
            tree = tree + "</ul></li>";
            return tree;
        }

        function findModule(name) {
            for (let i = 0; i < parts.length; i++) {
                if (parts[i].name == name) {
                    return i;
                }
            }
            return -1;
        }

        const primitives = ["circle", "square", "polygon", "text", "import", "projection", "sphere", "cube", "cylinder", "polyhedron", "linear_extrude", "rotate_extrude", "surface"];
        function getChildren(code, offset, fullcode) {
            let call_regexp = /\b(\w+)\s*\(([^)]*)\)\s*;/g;
            let calls = [...code.matchAll(call_regexp)];

            let children = [];
            calls.forEach((match) => {
                let call = match[1] + "(" + match[2] + ")";
                let moduleId = findModule(match[1]);
                let primId = primitives.indexOf(match[1]);
                if (moduleId != -1) {
                    children.push({
                        id: parts[moduleId].id,
                        name: match[1],
                        code: call,
                        start: offset + match.index,
                    });
                }

            });

            let names = [];
            for (let i = 0; i < children.length; i++) {
                names.push(children[i].name);
            }
            for (let i = 0; i < children.length; i++) {
                for (let j = 0; j < names.length; j++) {
                    if (i != j && children[i].name == names[j]) {
                        children[i].name = children[i].code;
                        break;
                    }
                }
            }

            return children;
        }

        function parseCode(code) {
            parts = [];
            currentPart = { index: 0, code: "", offset: 0 };
            parts.push({
                id: 0,
                name: "Full Model",
                description: "",
                children: [],
                code: "",
                start: 0,
                isModule: false
            });

            var globalCode = [];

            let def_regexp = /\bmodule\s+(\w+)\s*\(([^)]*)\)\s*{/g;
            let definitions = [...code.matchAll(def_regexp)];

            var id = 1;
            var prevModuleEnd = 0;
            definitions.forEach((match) => {
                let offset = code.substring(match.index);
                let body = XRegExp.matchRecursive(offset, '\\{', '\\}')[0];

                parts.push({
                    id: id,
                    name: match[1],
                    description: "",
                    children: [],
                    code: match[0] + body + "}",
                    start: match.index,
                    isModule: true
                });



                globalCode.push({ start: prevModuleEnd, code: code.slice(prevModuleEnd, match.index) });

                prevModuleEnd = match.index + match[0].length + body.length + 1;
                id++;
            });
            
            globalCode.push({ start: prevModuleEnd, code: code.slice(prevModuleEnd) });
            
            
            for (let i = 0; i < primitives.length; i++) {
                parts.push({
                    id: parts.length,
                    name: primitives[i],
                    description: "",
                    children: [],
                    code: "",
                    start: -1,
                    isModule: false
                });
            }
            

            globalCode.forEach((section) => {
                parts[0].children = parts[0].children.concat(getChildren(section.code, section.start, code));
            });

            parts.forEach((part) => {
                if (part.id != 0) {
                    part.children = getChildren(part.code, part.start, code);
                }
            });

            console.log(parts);

            // generate display tree
            var tree = getDisplayTree(parts[0], parts[0], "", 1);
            document.getElementById('openscad-code2').innerHTML = "<ul id=\"parts-tree\" aria-label=\"Parts of the model\" role=\"list\">" + tree + "</ul>";
            const curPart = document.getElementById('part-' + currentPart.index);
            curPart.checked = true;
            parts[0].code = code;

        }

        // on code change
        document.getElementById('openscad-code').addEventListener('change', function () {
            var code = document.getElementById('openscad-code').value;
            parseCode(code);
            
            document.getElementById('undo-code').disabled = false;
            document.getElementById('redo-code').disabled = true;

        });
    </script>



</body>

</html>
