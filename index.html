<!DOCTYPE html>
<html lang="en-US">
    
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>
        Code2Fab
    </title>
    <script src="https://cdn.tailwindcss.com">
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>

    <style>
        .code2fab-container {
            overflow-x: hidden;
        }

        .code2fab-content {
            white-space: pre-wrap;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .hidden {
            display: none;
        }

        .text-left {
            text-align: left;
        }

        pre {
            white-space: pre-wrap;
        }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>


<body class="bg-white h-screen ">
    
    <header>
        <h1>Code2Fab</h1>
    </header>
    <!-- Main Content -->
    <div class="flex w-full height:98vh">
        <!-- Code Editor area -->
        <div class="w-1/3 bg-white border-2 border-black m-1 flex-col flex flex-col " tabindex="0" aria-labelledby="editor-heading" role="region">
            <h1 role="heading" id="editor-heading">Code Editor Panel</h1>
            
            <div tabindex="0" aria-labelledby="editor-toolbar-heading" role="toolbar">
                <h2 role="heading" id="editor-toolbar-heading">Code Editor Toolbar</h2>
                <div class=" border-b border-gray-300 px-2 py-1 flex justify-between items-center flex-none  ">
                <div class="flex items-center space-x-1">
                    <button class="text-gray-600 hover:bg-gray-100 p-1 rounded border border-black"
                        id="upload-file" tabindex="0" aria-label="Upload OpenSCAD file"
                        aria-controls="file-input">
                        <i class="fas fa-upload" aria-hidden="true"></i>
                    </button>

                    <button class="text-gray-600 hover:bg-gray-100 p-1 rounded border border-black"
                        id="save-code" tabindex="0" aria-label="Save the OpenSCAD code">
                        <i class="fas fa-save" aria-hidden="true"></i>
                    </button>
                    
                    <input type="file" id="file-input" style="display: none;" accept=".scad"
                        aria-label="Open an OpenSCAD file.">
                        
                    <button tabindex="0" aria-label="Generate Model"
                        class="text-gray-600 hover:bg-gray-100 p-1 rounded interactive border border-black"
                        id="generate-model">
                        <!--<i class="fas fa-cube"></i>-->
                        Generate Model
                    </button>
                </div>
                </div>
            </div>
            
            <h2 role="heading" id="editor-input-heading">Code Editor Input Area</h2>
            <textarea tabindex="0" aria-labelledby="editor-input-heading" role="textbox"
            class="p-2 text-sm text-gray-700 font-mono focus:outline-none interactive"
            id="openscad-code" placeholder="Enter OpenSCAD code here"
            style="resize: none; height: calc(82vh - 36px); width: calc(100% - 4px);"
            data-hover-text="Enter OpenSCAD code here."></textarea>
        </div>
        <!-- Rendering Area -->
        <div class="w-1/3 flex-col border-2 border-black m-1"  tabindex="0" aria-labelledby="model-panel-heading" role="region">
            <h1 role="heading" id="model-panel-heading">Model Panel</h1>
            <div class="flex-col  m-1" id="col2">
                <!-- Viewport Content -->
                <div class="flex-grow  flex border border-black" style="height: calc(50vh - 40px);">
                    <div class="w-full flex-grow justify-center items-center overflow-auto" style="position: relative;" tabindex="0" aria-labelledby="rendered-heading"
                role="region">
                        <h2 role="heading" id="rendered-heading">Rendered model</h2>
                        
                        <!-- Model viewer goes here -->
                        <img id="modelImage" src="logo.png" tabindex="0" aria-label="Rendered model"
                            aria-describedby="code2fab-response" role="img" class="max-w-full max-h-full">
                        <!-- Initially hide the image -->

                    </div>
                </div>
                
                <div class="w-full h-1/2 overflow-auto" tabindex="0" aria-labelledby="parts-heading">
                    <h2 role="heading" id="parts-heading">Model parts</h2>
                    <div 
                        class="h-full p-2 text-sm text-gray-700 font-mono focus:outline-none interactive"
                        id="openscad-code2" placeholder="The modular structure of the code will appear here"
                        style="resize: none; height: screen; width: calc(100% - 2px);">
                        <p>The parts of model will appear here...</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- AI Area -->
        <div class="w-1/3 border-2 border-black m-1 flex-col overflow-auto" tabindex="0" aria-labelledby="ai-panel-heading" role="region">
            <h1 role="heading" id="ai-panel-heading">AI Assistance Panel</h1>
            <div class="border border-black" tabindex="0" aria-labelledby="prompt-heading" role="region">
                <!-- Prompt Area at the top-->
                <h2 role="heading" id="prompt-heading">Prompt:</h2>
                <div class="h-1/4 mb-1 overflow-auto flex flex-col border border-black mx-1">
                    
                    <div class="h-1/4">
                        <textarea class="w-full p-2 text-sm text-gray-700 font-mono focus:outline-none interactive mb-2 bg-gray-100"
                            id="gpt-input" placeholder="Enter your prompt here" style="resize: none; height: 14vh;"
                            aria-label="Prompt box" role="textbox"></textarea>
                        <!-- Buttons below the prompt textbox -->
                        <button aria-label="Submit prompt"
                            class="flex justify-end items-end text-black font-bold py-1 px-4 rounded border border-black m-2"
                            id="callGPT">
                            Enter
                        </button>

                    </div>
                </div>
            </div>
                <!-- Response Area at the bottom -->
                <div class=" mt-2 pt-2 " tabindex="0" aria-labelledby="response-heading" role="status" aria-live="polite">
                    <h2 role="heading" id="response-heading">Code2fab Response:</h2>
                    <div class="code2fab-container w-full text-sm text-gray-700 font-mono flex-col"
                    style="height: 3/4;">
                        <!-- GPT response content goes here -->
                        <div id="code2fab-response" 
                            class="code2fab-content h-full overflow-auto text-gray-500 interactive flex-shrink-0"
                            data-hover-text="Code2fab's response"><br><br> Model description not yet generated<br>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    </div>
    </div>

    <script src="https://unpkg.com/xregexp/xregexp-all.js"></script>
    <script>
        const serverUrl = 'http://128.46.81.235:3000'

        // Display and update the status
        const statusDisplay = document.getElementById('statusText');
        function updateStatusAndSpeak(text) {
            //speechSynthesis.cancel();
            //statusDisplay.textContent = text;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 5;
            //speechSynthesis.speak(utterance);
        }

        const elements = [
            { id: "save-code", key: "Ctrl+Shift+S", text: "Save the OpenSCAD code." },
            //{ id: "refresh-files", key: "Ctrl+Shift+R", text: "Clear the file list." },
            { id: "upload-file", key: "Ctrl+Shift+U", text: "Upload a new OpenSCAD file." },
            //{ id: "file-list", key: "Ctrl+Shift+L", text: "Open the version list." },
            { id: "generate-model", key: "Ctrl+Shift+G", text: "Generate a 3D model from the code." },
            { id: "openscad-code", key: "Ctrl+Shift+O", text: "Enter OpenSCAD code here." },
            { id: "gpt-input", key: "Ctrl+Shift+P", text: "Enter your input here." },
        ];


        document.addEventListener('keydown', function (event) {
            //console.log(event.key, event.ctrlKey, event.shiftKey); 
            if (event.ctrlKey && event.shiftKey) {
                elements.forEach(item => {
                    if (event.key.toUpperCase() === item.key.split('+').pop()) {
                        const element = document.getElementById(item.id);
                        if (element) {
                            element.focus();
                            updateStatusAndSpeak(item.text);
                        }
                    }
                });
            }
        });

        elements.forEach(item => {
            const element = document.getElementById(item.id);
            if (element) {
                element.addEventListener('focus', function () {
                    updateStatusAndSpeak(item.text);
                });
                element.addEventListener('mouseenter', function () {
                    updateStatusAndSpeak(item.text);
                });
            }
        });

        const imageBasePath = '/static/img/model/';
        const totalImages = 7; // Assuming images are named from 0.jpg to 6.jpg
        let currentImageIndex = 0;

        var prevCode = '';
        var prevImg = '';
        var parts = [];
        let currentPartIndex = 0;
        let currentPartOffset = 0;
        parts.push({
            id: 0,
            name: "Model",
            description: "",
            children: [],
            code: "",
            isModule: false
        });


        async function genImageAndDescribe(index, text) {
            var code = document.getElementById('openscad-code').value;
            var fullCode = "";
            if (currentPartIndex != 0) {
                fullCode = code;
                code = parts[0].code;
                code = code.slice(0, currentPartOffset) + "!" + code.slice(currentPartOffset);
            }
            const responseContainer = document.getElementById('code2fab-response');
            responseContainer.innerHTML = '<pre></pre>';
            const pre = responseContainer.querySelector('pre');
            //console.log("Generating images for code:", code);

            try {
                // Generate images from code
                const generateResponse = await fetch(serverUrl + '/generate-img', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, fullCode: fullCode, imageIndex: index })
                });

                if (!generateResponse.ok) {
                    throw new Error(`HTTP error! Status: ${generateResponse.status}`);
                }

                const generateData = await generateResponse.json();

                console.log(generateData);

                if (generateData.message && generateData.message === "Images generated successfully") {
                    updateStatusAndSpeak("Images have been successfully generated.");

                    const byteCharacters = atob(generateData.image);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);

                    const imageElement = document.getElementById('modelImage');
                    imageElement.src = URL.createObjectURL(new Blob([byteArray], { type: 'image/png' }));

                    //const instructions = document.getElementById('placeholder');
                    //instructions.style["display"] = "none";

                    //updateImageDisplay(0); // Reset to the first image

                    // Now process the model image and send it along with the text and code
                    updateStatusAndSpeak("The system reply is loading...");

                    // Wait for the model image to be updated in the DOM
                    setTimeout(() => {
                        var code = document.getElementById('openscad-code').value;
                        var fullCode = "";
                        if (currentPartIndex != 0) {
                            fullCode = code;
                            for (let i = 0; i < parts.length; i++) {
                                if (parts[i].id == currentPartIndex) {
                                    code = parts[i].code;
                                    break;
                                }
                            }
                        }
                        const responseContainer = document.getElementById('code2fab-response');
                        responseContainer.ariaLabel = "";
                        responseContainer.innerHTML = '<pre></pre>';
                        const pre = responseContainer.querySelector('pre');
                        updateStatusAndSpeak("The system reply is loading...")
                        
                        var body = { text: text, code: code, image: generateData.thumbnail, prevCode: prevCode, prevImg: prevImg, fullCode: fullCode, fullImg: generateData.fullImg };
                        if (text != "") {
                          body["prevCode"] = "";
                          body["prevImg"] = "";
                        }

                        fetch(serverUrl + '/api/describe', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        })
                            .then(response => {

                                console.log(response);
                                const reader = response.body.getReader();
                                function processStream({ done, value }) {
                                    if (done) {
                                        console.log('Stream completed');
                                        updateStatusAndSpeak("Please check the system reply.");
                                        var section = document.getElementById('code2fab-response');
                                        section.focus();
                                        return;
                                    }
                                    const chunk = new TextDecoder().decode(value);

                                    pre.textContent += chunk;

                                    const responseContainer = document.getElementById('code2fab-response');
                                    responseContainer.ariaLabel += chunk;

                                    return reader.read().then(processStream);
                                }
                                return reader.read().then(processStream);
                                updateStatusAndSpeak("Please try again.");
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                updateStatusAndSpeak("Please try again.");
                            });

                        prevCode = code;
                        prevImg = generateData.thumbnail;

                    }, 1);

                } else {
                    console.error("Failed to generate or retrieve images.");
                    updateStatusAndSpeak("Failed to generate images.");
                }
            } catch (error) {
                console.error('Error during generation or loading:', error);
                updateStatusAndSpeak("An error occurred during image generation.");
            }

        }

        document.getElementById('generate-model').addEventListener('click', async function () {

            await genImageAndDescribe(currentImageIndex, "");

        });
        
        document.getElementById('callGPT').addEventListener('click', async function () {
            const textInput = document.getElementById('gpt-input').value.trim();
            await genImageAndDescribe(currentImageIndex, textInput);

        });

        function modelPartSelected(e) {
            prevCode = "";
            prevImg = "";
            
            var checkbox = e.target;
            if (checkbox.checked) {
                const prevPart = document.getElementById('part-' + currentPartIndex);
                prevPart.checked = false;
                currentPartIndex = checkbox.value;
                currentPartOffset = checkbox.getAttribute("data-offset");
            } else {
                currentPartIndex = 0;
                currentPartOffset = 0;
                const fullModel = document.getElementById('part-0');
                fullModel.checked = true;
            }
        }


        document.addEventListener('keydown', async function (event) {
            if (event.shiftKey && event.key.toUpperCase() === 'V') {
                //if (event.key === 'ArrowRight') {
                currentImageIndex = (currentImageIndex + 1) % totalImages; // Increment index and loop back to 0
                /*} else if (event.key === 'ArrowLeft') {
                    currentImageIndex = (currentImageIndex - 1 + totalImages) % totalImages; // Decrement index and loop back to 6
                }*/
                //updateImageDisplay(currentImageIndex);
                await genImageAndDescribe(currentImageIndex, "");
                updateStatusAndSpeak(`Viewing image number ${currentImageIndex}.`);
            }

            if (event.altKey && (event.key === '!' || event.key === '@' || event.key === '#')) {
                var col = '1';
                if (event.key === '@') {
                    col = '2';
                } else if (event.key === '#') {
                    col = '3';
                }
                var column = document.getElementById('col' + col);
                column.focus();
            }

            if (event.shiftKey && event.altKey) {
                if (event.key.toUpperCase() == 'G') {
                    await genImageAndDescribe(currentImageIndex, "");
                } else if (event.key.toUpperCase() == 'D') {
                    var section = document.getElementById('code2fab-response');
                    section.focus();
                } else if (event.key.toUpperCase() == 'E') {
                    var section = document.getElementById('openscad-code');
                    section.focus();
                } else if (event.key.toUpperCase() == 'S') {
                    saveCode();
                } else if (event.key.toUpperCase() == 'O') {
                    document.getElementById('file-input').click();
                    var section = document.getElementById('openscad-code');
                    section.focus();
                    prevCode = "";
                    prevImg = "";
                } else if (event.key.toUpperCase() == 'H') {
                    const instructions = document.getElementById('placeholder');
                    instructions.style["display"] = "block";
                    instructions.focus();
                } else if (event.key.toUpperCase() == 'C') {
                    var section = document.getElementById('toolbar');
                    section.focus();
                }
            }
        });
        

        function updateImageDisplay(index) {
            const imageElement = document.getElementById('modelImage');
            const placeholder = document.getElementById('placeholder');

            // Check if the index is within the valid range
            if (index >= 0 && index <= 6) {
                const imagePath = `${imageBasePath}${index}.png`;
                imageElement.src = imagePath;
                imageElement.onerror = function () {
                    // If the image fails to load, hide the image and show the placeholder
                    imageElement.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                };
                imageElement.onload = function () {
                    // If the image loads successfully, show the image and hide the placeholder
                    imageElement.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                };
            } else {
                // If the index is out of the valid range, hide the image and show the placeholder
                imageElement.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        function saveCode() {
            const code = document.getElementById('openscad-code').value;
            let fileName = prompt("Enter file name (leave blank for automatic naming):");

            if (fileName === null) {
                return;
            }

            if (fileName.trim() === '') {
                fileName = undefined;
            } else {
                if (!fileName.endsWith('.scad')) {
                    fileName += '.scad';
                }
            }

            const link = document.createElement("a");
            const content = code;
            const file = new Blob([content], { type: 'text/plain' });
            link.href = URL.createObjectURL(file);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // Save the code to a file
        document.getElementById('save-code').addEventListener('click', function () {
            saveCode();

        });

        // Load code from a file
        function loadCode(fileName) {
            fetch(serverUrl + `/load-code/${fileName}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('openscad-code').value = data.code;
                    console.log(`Loaded code from file: ${fileName}`);
                })
                .catch(error => {
                    console.error('Error loading code:', error);
                    console.error('Error loading file.');
                });
        }

        // Upload a file
        document.getElementById('upload-file').addEventListener('click', function () {
            document.getElementById('file-input').click();
            var section = document.getElementById('openscad-code');
            section.focus();
            prevCode = "";
            prevImg = "";
        });
        document.getElementById('file-input').addEventListener('change', function (event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('openscad-code').value = e.target.result;
                console.log(`Uploaded file: ${file.name}`);
                parseCode(e.target.result.toLowerCase());
                genImageAndDescribe(currentImageIndex, "");
            };
            reader.readAsText(file);
        });


        
        function getDisplayTree(root, child, index) {
            
            
            let tree = "<li style=\"padding-left: 10px;\" aria-labelledby=\"part-" + root.id + "-label\" role=\"treeitem\" tabindex=\"0\"><label for=\"part-" + root.id + "\" id=\"part-" + root.id + "-label\" >" +child.name + " </label>"
            + "<input type=\"checkbox\" id=\"part-" + root.id + "\" name=\"parts\" value=\""+root.id+"\" data-offset=\""+child.start+"\" tabindex=\"0\" aria-labelledby=\"part-" + root.id + "-label\" role=\"checkbox\" onchange=\"modelPartSelected(event)\">";
            
            if (root.id == -1 || root.children.length == 0) {
                return tree+"</li>";
            }
            const children = root.children;

            tree = tree + "<ul style=\"padding-left: 10px;\" role=\"group\">";
            for (let i = 0; i < children.length; i++) {
                tree = tree + getDisplayTree(parts[children[i].id], children[i], index + (i + 1) + ".");
            }
            tree = tree + "</ul></li>";
            return tree;
        }
        
        function findModule(name) {
          for (let i = 0; i < parts.length; i++) {
              if (parts[i].name == name) {
                return i;
              }
          }
          return -1;
        }
        
        const primitives = ["circle", "square", "polygon", "text", "import", "projection", "sphere", "cube", "cylinder", "polyhedron", "linear_extrude", "rotate_extrude", "surface"];
        function getChildren(code, offset, fullcode) {
            let call_regexp = /\b(\w+)\s*\(([^)]*)\)\s*;/g;
            let calls = [...code.matchAll(call_regexp)];
            
            let children = [];
            calls.forEach((match) => {
                let call = match[1];
                let moduleId = findModule(call);
                let primId = primitives.indexOf(call);
                if (primId != -1) {
                  /*children.push({
                      id: -1,
                      name: call,
                      start: offset+match.index,
                  });*/
                } else if (moduleId != -1) {
                  if (match[2] != "" && match[2].length < 50) {
                    call += "("+match[2]+")"
                  }
                  children.push({
                      id: parts[moduleId].id,
                      name: call,
                      start: offset+match.index,
                  });
                  
                }
                
            });
            
            return children;
        }

        function parseCode(code) {
            parts = [];
            currentPartIndex = 0;
            currentPartOffset = 0;
            parts.push({
                id: 0,
                name: "Full Model",
                description: "",
                children: [],
                code: code,
                start: 0,
                isModule: false
            });
            
            var globalCode = [];
            
            let def_regexp = /\bmodule\s+(\w+)\s*\(([^)]*)\)\s*{/g;
            let definitions = [...code.matchAll(def_regexp)];
            
            var id = 1;
            var prevModuleEnd = 0;
            definitions.forEach((match) => {
                let offset = code.substring(match.index);
                let body = XRegExp.matchRecursive(offset, '\\{', '\\}')[0];
                
                parts.push({
                    id: id,
                    name: match[1],
                    description: "",
                    children: [],
                    code: body,
                    start: match.index + match[0].length,
                    isModule: true
                });
                
                
                
                globalCode.push({start:prevModuleEnd, code: code.slice(prevModuleEnd, match.index)});
                
                prevModuleEnd = match.index+match[0].length+body.length+1;
                id++;
            });
            
            globalCode.forEach((section) => {
                parts[0].children = parts[0].children.concat(getChildren(section.code, section.start, code));
            });
            
            parts.forEach((part) => {
                if (part.id != 0) {
                    part.children = getChildren(part.code, part.start, code);
                }
            });
            
            console.log(parts);
            
            // generate display tree
            var tree = getDisplayTree(parts[0], parts[0], "");
            document.getElementById('openscad-code2').innerHTML = "<ul id=\"parts-tree\" aria-label=\"Parts of the model\" role=\"tree\">" + tree + "</ul>";
            const curPart = document.getElementById('part-' + currentPartIndex);
            curPart.checked = true;

        }

        // on code change
        document.getElementById('openscad-code').addEventListener('change', function () {
            var code = document.getElementById('openscad-code').value;
            code = code.toLowerCase();

            parseCode(code);

        });
    </script>



</body>

</html>